<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Experiencia Laboral</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 10px; font-size: 32px; }
        h2 { color: #555; margin-bottom: 20px; font-size: 24px; }
        h3 { color: #666; margin-bottom: 15px; font-size: 20px; }
        .info-box { background: #e3f2fd; border-left: 4px solid #2196F3; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .info-box p { color: #1565C0; font-size: 14px; margin: 5px 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 8px; color: #555; font-size: 14px; }
        input, textarea, select { padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: border 0.3s; font-family: inherit; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; }
        textarea { resize: vertical; min-height: 120px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #10b981; color: white; }
        .btn-secondary:hover { background: #059669; }
        .btn-success { background: #10b981; color: white; width: 100%; justify-content: center; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; padding: 8px 12px; }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: #f59e0b; color: white; padding: 8px 12px; }
        .btn-warning:hover { background: #d97706; }
        .btn-info { background: #06b6d4; color: white; }
        .btn-info:hover { background: #0891b2; }
        .btn-small { padding: 6px 12px; font-size: 14px; }
        .file-upload-area { border: 2px dashed #667eea; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s; background: #f8f9ff; }
        .file-upload-area:hover { border-color: #5568d3; background: #eef0ff; }
        .file-upload-area input { display: none; }
        .file-name { color: #667eea; font-weight: 600; margin-top: 10px; min-height: 20px; }
        .contract-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .contract-table th { background: #f3f4f6; padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e5e7eb; font-size: 13px; }
        .contract-table td { padding: 12px; border-bottom: 1px solid #e5e7eb; vertical-align: top; }
        .contract-table tr:hover { background: #f9fafb; }
        .contract-table input[type="date"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .contract-table input[type="date"]:focus { border-color: #667eea; outline: none; }
        .contract-table input, .contract-table textarea, .contract-table select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 13px; }
        .contract-table textarea { resize: vertical; min-height: 60px; }
        .contract-table input:focus, .contract-table textarea:focus, .contract-table select:focus { border-color: #667eea; outline: none; }
        .action-buttons { display: flex; gap: 5px; }
        .warning-box { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .warning-box p { color: #92400e; font-size: 14px; margin: 5px 0; }
        .result-box { background: #dbeafe; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #3b82f6; }
        .result-box p { font-size: 18px; font-weight: 600; color: #1e40af; }
        .candidate-card { border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 15px; transition: all 0.3s; }
        .candidate-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .candidate-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .candidate-info h3 { margin-bottom: 5px; }
        .candidate-info p { color: #666; font-size: 14px; margin: 3px 0; }
        .experience-badge { background: #dcfce7; border-left: 4px solid #10b981; padding: 15px; margin: 15px 0; border-radius: 8px; }
        .experience-badge p { color: #065f46; font-size: 18px; font-weight: 700; }
        details { cursor: pointer; margin-top: 15px; }
        summary { font-weight: 600; color: #667eea; padding: 10px; background: #f3f4f6; border-radius: 6px; }
        summary:hover { background: #e5e7eb; }
        .contract-list { margin-top: 10px; padding-left: 20px; }
        .contract-list-item { background: #f9fafb; padding: 12px; margin: 8px 0; border-radius: 6px; border-left: 3px solid #667eea; }
        .divider { border: none; border-top: 2px solid #e5e7eb; margin: 30px 0; }
        .helper-text { font-size: 12px; color: #6b7280; margin-top: 5px; }
        .error-row { background: #fee2e2 !important; }
        .success-message { background: #d1fae5; color: #065f46; padding: 12px; border-radius: 6px; margin: 10px 0; }
        .validation-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 14px; }
        .validation-badge.validated { background: #dcfce7; color: #065f46; }
        .validation-badge.pending { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üìä Calculadora de Experiencia Laboral y Docente</h1>
            <div class="info-box">
                <p><strong>üí° Instrucci√≥n:</strong> Carga los archivos Excel con experiencia profesional y docente de todos los candidatos</p>
                <p>‚úÖ El sistema organizar√° la informaci√≥n autom√°ticamente por identificaci√≥n y permitir√° validar y editar cada candidato</p>
            </div>

            <div class="form-grid">
                <div class="file-upload-area" onclick="document.getElementById('professionalFile').click()">
                    <div style="font-size: 48px;">üìÑ</div>
                    <div style="font-weight: 600; margin: 10px 0;">Experiencia Profesional</div>
                    <div style="font-size: 12px; color: #666;">Click para seleccionar archivo Excel</div>
                    <input type="file" id="professionalFile" accept=".xlsx,.xls">
                    <div class="file-name" id="profFileName"></div>
                </div>

                <div class="file-upload-area" onclick="document.getElementById('teachingFile').click()">
                    <div style="font-size: 48px;">üéì</div>
                    <div style="font-weight: 600; margin: 10px 0;">Experiencia Docente</div>
                    <div style="font-size: 12px; color: #666;">Click para seleccionar archivo Excel</div>
                    <input type="file" id="teachingFile" accept=".xlsx,.xls">
                    <div class="file-name" id="teachFileName"></div>
                </div>
            </div>

            <button class="btn btn-primary" id="loadFilesBtn" onclick="loadExcelFiles()" disabled style="width: 100%;">
                üì• Cargar Archivos y Procesar Candidatos
            </button>
        </div>

        <div class="card" id="candidatesList" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="margin: 0;">üìã Candidatos Cargados (<span id="candidatesCount">0</span>)</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="exportAllCandidates()">üìä Reporte Excel</button>
                    <button class="btn btn-primary" onclick="exportToJSON()">üíæ Backup JSON</button>
                    <button class="btn btn-primary" onclick="importFromJSON()">üì• Importar JSON(s)</button>
                    <button class="btn btn-warning" onclick="checkDuplicatesInFiles()">üîç Analizar Duplicados</button>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Limpiar Todo</button>
                </div>
            </div>
            <div class="info-box" style="margin-bottom: 15px;">
                <p><strong>üíæ Guardado Autom√°tico:</strong> Todos los cambios se guardan autom√°ticamente en tu navegador.</p>
                <p><strong>‚úèÔ∏è Edici√≥n:</strong> Puedes editar directamente en las tablas, duplicar o eliminar registros.</p>
                <p><strong>‚úÖ Validaci√≥n:</strong> Marca cada candidato como validado cuando termines de revisar su informaci√≥n.</p>
            </div>
            <div id="candidatesContainer"></div>
        </div>
    </div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script>
        let candidates = [];
        const REFERENCE_DATE = new Date('2025-09-17');

        window.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            renderCandidates();
        });

        document.getElementById('professionalFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('profFileName').textContent = '‚úì ' + file.name;
                checkFilesLoaded();
            }
        });

        document.getElementById('teachingFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('teachFileName').textContent = '‚úì ' + file.name;
                checkFilesLoaded();
            }
        });

        function checkFilesLoaded() {
            const profFile = document.getElementById('professionalFile').files[0];
            const teachFile = document.getElementById('teachingFile').files[0];
            document.getElementById('loadFilesBtn').disabled = !profFile && !teachFile;
        }

        function parseDateString(dateStr) {
            if (!dateStr) return null;
            
            // Convertir a string y limpiar espacios extra
            dateStr = String(dateStr).trim().replace(/\s+/g, ' ');
            
            // Verificar si es fecha de referencia espec√≠fica
            if (dateStr === '31-12-1969 0:00' || dateStr === '31-12-1969') {
                return null;
            }
            
            // Formato: 'd-m-yyyy  0:00' o 'dd-mm-yyyy 0:00' (puede tener espacios dobles)
            const match = dateStr.match(/^(\d{1,2})-(\d{1,2})-(\d{4})/);
            if (match) {
                const day = match[1].padStart(2, '0');
                const month = match[2].padStart(2, '0');
                const year = match[3];
                
                // Validar que d√≠a y mes sean v√°lidos
                if (parseInt(day) > 31 || parseInt(day) < 1) return null;
                if (parseInt(month) > 12 || parseInt(month) < 1) return null;
                
                return `${year}-${month}-${day}`;
            }
            
            // Formato: 'd/m/yyyy' o 'dd/mm/yyyy'
            const match2 = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (match2) {
                const day = match2[1].padStart(2, '0');
                const month = match2[2].padStart(2, '0');
                const year = match2[3];
                
                if (parseInt(day) > 31 || parseInt(day) < 1) return null;
                if (parseInt(month) > 12 || parseInt(month) < 1) return null;
                
                return `${year}-${month}-${day}`;
            }
            
            // Si ya est√° en formato ISO (yyyy-mm-dd)
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            return null;
        }

        function processDate(dateValue) {
            // Si es undefined, null, vac√≠o o la fecha especial -> usar fecha de referencia
            if (dateValue === undefined || 
                dateValue === null || 
                dateValue === '' || 
                String(dateValue).trim() === '' ||
                String(dateValue).trim() === '31-12-1969  0:00' || 
                String(dateValue).trim() === '31-12-1969 0:00') {
                return REFERENCE_DATE.toISOString().split('T')[0];
            }
            
            // Si es n√∫mero de serie de Excel
            if (typeof dateValue === 'number') {
                const date = new Date((dateValue - 25569) * 86400 * 1000);
                if (isNaN(date.getTime())) return REFERENCE_DATE.toISOString().split('T')[0];
                return date.toISOString().split('T')[0];
            }
            
            // Intentar parsear como string
            const parsedStr = parseDateString(dateValue);
            
            // Si no se pudo parsear, usar fecha de referencia
            if (!parsedStr) {
                console.log('No se pudo parsear fecha:', dateValue);
                return REFERENCE_DATE.toISOString().split('T')[0];
            }
            
            // Validar que la fecha sea v√°lida
            const date = new Date(parsedStr);
            if (isNaN(date.getTime())) {
                console.log('Fecha inv√°lida despu√©s de parsear:', parsedStr);
                return REFERENCE_DATE.toISOString().split('T')[0];
            }
            
            return parsedStr;
        }

        async function loadExcelFiles() {
            const profFile = document.getElementById('professionalFile').files[0];
            const teachFile = document.getElementById('teachingFile').files[0];

            const profData = profFile ? await loadProfessionalExperience(profFile) : {};
            const teachData = teachFile ? await loadTeachingExperience(teachFile) : {};

            const allIds = new Set([...Object.keys(profData), ...Object.keys(teachData)]);
            
            allIds.forEach(id => {
                const existing = candidates.find(c => c.cedula === id);
                if (!existing) {
                    const candidate = {
                        firstName: profData[id]?.name || teachData[id]?.name || '',
                        lastName: profData[id]?.name || teachData[id]?.name || '',
                        fullName: profData[id]?.name || teachData[id]?.name || '',
                        cedula: id,
                        generalComments: '',
                        contracts: profData[id]?.contracts || [],
                        teachingExperience: teachData[id]?.teaching || [],
                        totalExperience: 0,
                        savedAt: new Date().toLocaleString(),
                        validated: false
                    };
                    
                    const allExperiences = [];
                    candidate.contracts.forEach(c => {
                        allExperiences.push({startDate: c.startDate, endDate: c.endDate});
                    });
                    candidate.teachingExperience.forEach(t => {
                        const equivDays = calculateTeachingEquivalent(t);
                        const start = new Date(t.startDate);
                        const adjustedEnd = new Date(start.getTime() + (equivDays * 24 * 60 * 60 * 1000));
                        allExperiences.push({
                            startDate: t.startDate,
                            endDate: adjustedEnd.toISOString().split('T')[0]
                        });
                    });
                    candidate.totalExperience = calculateTotalExperience(allExperiences);
                    
                    candidates.push(candidate);
                }
            });

            saveToStorage();
            renderCandidates();
            alert(`‚úÖ Se cargaron ${allIds.size} candidatos exitosamente`);
        }

        async function loadProfessionalExperience(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet);

                        const byCandidate = {};
                        
                        rows.forEach(row => {
                            const id = String(row.Identificacion || row.identificacion || '').trim();
                            if (!id) return;

                            if (!byCandidate[id]) {
                                byCandidate[id] = {
                                    name: row.Nombre || row.nombre || '',
                                    contracts: []
                                };
                            }

                            // Procesar fecha_inicio - NUNCA debe ser la fecha de referencia a menos que est√© realmente vac√≠a
                            const fechaInicio = row.fecha_inicio || row.fechaInicio || row.FECHA_INICIO;
                            const startDate = processDate(fechaInicio);
                            
                            // Procesar fecha_retiro - SI puede ser la fecha de referencia si est√° vac√≠a
                            const fechaRetiro = row.fecha_retiro || row.fechaRetiro || row.FECHA_RETIRO;
                            const endDate = processDate(fechaRetiro);

                            byCandidate[id].contracts.push({
                                id: Date.now() + Math.random(),
                                city: row.ciudad || row.CIUDAD || '',
                                company: row.entidad || row.ENTIDAD || '',
                                position: row.cargo || row.CARGO || '',
                                startDate: startDate,
                                endDate: endDate,
                                comments: ''
                            });
                        });

                        resolve(byCandidate);
                    } catch (error) {
                        alert('Error al cargar experiencia profesional: ' + error.message);
                        resolve({});
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function loadTeachingExperience(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet);

                        const byCandidate = {};
                        
                        rows.forEach(row => {
                            const id = String(row.Identificacion || row.identificacion || '').trim();
                            if (!id) return;

                            if (!byCandidate[id]) {
                                byCandidate[id] = {
                                    name: row.Nombre || row.nombre || '',
                                    teaching: []
                                };
                            }

                            let dedication = row.dedicacion || row.DEDICACION || '';
                            if (dedication.toLowerCase().includes('completo')) {
                                dedication = 'Tiempo completo';
                            } else if (dedication.toLowerCase().includes('medio')) {
                                dedication = 'Medio tiempo';
                            } else if (dedication.toLowerCase().includes('catedra') || dedication.toLowerCase().includes('c√°tedra')) {
                                dedication = 'Hora Catedra';
                            }

                            // Procesar fecha_ingreso - NUNCA debe ser la fecha de referencia a menos que est√© realmente vac√≠a
                            const fechaIngreso = row.fecha_ingreso || row.fechaIngreso || row.FECHA_INGRESO;
                            const startDate = processDate(fechaIngreso);
                            
                            // Procesar fecha_retiro - SI puede ser la fecha de referencia si est√° vac√≠a
                            const fechaRetiro = row.fecha_retiro || row.fechaRetiro || row.FECHA_RETIRO;
                            const endDate = processDate(fechaRetiro);

                            byCandidate[id].teaching.push({
                                id: Date.now() + Math.random(),
                                city: row.ciudad || row.CIUDAD || '',
                                institution: row.institucion || row.INSTITUCION || '',
                                modality: row.modalidad || row.MODALIDAD || '',
                                program: row.programa || row.PROGRAMA || '',
                                dedication: dedication,
                                hoursPerWeek: null,
                                startDate: startDate,
                                endDate: endDate,
                                comments: ''
                            });
                        });

                        resolve(byCandidate);
                    } catch (error) {
                        alert('Error al cargar experiencia docente: ' + error.message);
                        resolve({});
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function saveToStorage() {
            try {
                localStorage.setItem('candidatesData', JSON.stringify(candidates));
                return true;
            } catch (e) {
                console.error('Error al guardar:', e);
                return false;
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('candidatesData');
                if (saved) {
                    candidates = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error al cargar:', e);
                candidates = [];
            }
        }

        function toggleValidation(index) {
            candidates[index].validated = !candidates[index].validated;
            saveToStorage();
            renderCandidates();
        }

        function updateContract(candidateIndex, id, field, value) {
            const contract = candidates[candidateIndex].contracts.find(c => c.id === id);
            if (contract) {
                contract[field] = value;
                saveToStorage();
            }
        }

        function updateTeaching(candidateIndex, id, field, value) {
            const teaching = candidates[candidateIndex].teachingExperience.find(t => t.id === id);
            if (teaching) {
                teaching[field] = value;
                saveToStorage();
            }
        }

        function deleteContract(candidateIndex, id) {
            if (confirm('¬øEliminar este contrato?')) {
                candidates[candidateIndex].contracts = candidates[candidateIndex].contracts.filter(c => c.id !== id);
                recalculateExperience(candidateIndex);
                saveToStorage();
                renderCandidates();
            }
        }

        function deleteTeaching(candidateIndex, id) {
            if (confirm('¬øEliminar esta experiencia docente?')) {
                candidates[candidateIndex].teachingExperience = candidates[candidateIndex].teachingExperience.filter(t => t.id !== id);
                recalculateExperience(candidateIndex);
                saveToStorage();
                renderCandidates();
            }
        }

        function duplicateContract(candidateIndex, id) {
            const index = candidates[candidateIndex].contracts.findIndex(c => c.id === id);
            if (index !== -1) {
                const contract = candidates[candidateIndex].contracts[index];
                const newContract = {...contract, id: Date.now()};
                candidates[candidateIndex].contracts.splice(index + 1, 0, newContract);
                saveToStorage();
                renderCandidates();
            }
        }

        function duplicateTeaching(candidateIndex, id) {
            const index = candidates[candidateIndex].teachingExperience.findIndex(t => t.id === id);
            if (index !== -1) {
                const teaching = candidates[candidateIndex].teachingExperience[index];
                const newTeaching = {...teaching, id: Date.now()};
                candidates[candidateIndex].teachingExperience.splice(index + 1, 0, newTeaching);
                saveToStorage();
                renderCandidates();
            }
        }

        function recalculateExperience(candidateIndex) {
            const candidate = candidates[candidateIndex];
            const allExperiences = [];
            
            candidate.contracts.forEach(c => {
                allExperiences.push({startDate: c.startDate, endDate: c.endDate});
            });
            
            candidate.teachingExperience.forEach(t => {
                const equivDays = calculateTeachingEquivalent(t);
                const start = new Date(t.startDate);
                const adjustedEnd = new Date(start.getTime() + (equivDays * 24 * 60 * 60 * 1000));
                allExperiences.push({
                    startDate: t.startDate,
                    endDate: adjustedEnd.toISOString().split('T')[0]
                });
            });

            candidate.totalExperience = calculateTotalExperience(allExperiences);
        }

        function calculateTeachingEquivalent(teaching) {
            const start = new Date(teaching.startDate);
            const end = new Date(teaching.endDate);
            const totalDays = (end - start) / (1000 * 60 * 60 * 24);

            if (teaching.dedication === 'Tiempo completo') {
                return totalDays;
            } else if (teaching.dedication === 'Medio tiempo') {
                return totalDays / 2;
            } else if (teaching.dedication === 'Hora Catedra') {
                const weeks = totalDays / 7;
                const totalHours = weeks * (teaching.hoursPerWeek || 0);
                const months = totalHours / 206;
                return months * 30;
            }
            return 0;
        }

        function getOverlaps(contracts) {
            const overlaps = [];
            const sorted = [...contracts].sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            for (let i = 0; i < sorted.length; i++) {
                for (let j = i + 1; j < sorted.length; j++) {
                    const start1 = new Date(sorted[i].startDate).getTime();
                    const end1 = new Date(sorted[i].endDate).getTime();
                    const start2 = new Date(sorted[j].startDate).getTime();
                    const end2 = new Date(sorted[j].endDate).getTime();

                    const overlapStart = Math.max(start1, start2);
                    const overlapEnd = Math.min(end1, end2);
                    const overlapDays = overlapStart < overlapEnd ? (overlapEnd - overlapStart) / (1000 * 60 * 60 * 24) : 0;

                    if (overlapDays > 0) {
                        overlaps.push({
                            contract1: sorted[i],
                            contract2: sorted[j],
                            days: overlapDays
                        });
                    }
                }
            }

            return overlaps;
        }

        function calculateTotalExperience(contracts) {
            if (contracts.length === 0) return 0;

            const sorted = [...contracts]
                .map(c => ({
                    ...c,
                    start: new Date(c.startDate).getTime(),
                    end: new Date(c.endDate).getTime()
                }))
                .sort((a, b) => a.start - b.start);

            let totalDays = 0;
            const mergedPeriods = [];

            for (const contract of sorted) {
                if (mergedPeriods.length === 0) {
                    mergedPeriods.push({ start: contract.start, end: contract.end });
                    totalDays += (contract.end - contract.start) / (1000 * 60 * 60 * 24);
                } else {
                    const lastPeriod = mergedPeriods[mergedPeriods.length - 1];
                    
                    if (contract.start <= lastPeriod.end) {
                        const overlapStart = Math.max(lastPeriod.start, contract.start);
                        const overlapEnd = Math.min(lastPeriod.end, contract.end);
                        const overlap = overlapStart < overlapEnd ? (overlapEnd - overlapStart) / (1000 * 60 * 60 * 24) : 0;
                        totalDays += ((contract.end - contract.start) / (1000 * 60 * 60 * 24)) - overlap;
                        lastPeriod.end = Math.max(lastPeriod.end, contract.end);
                    } else {
                        mergedPeriods.push({ start: contract.start, end: contract.end });
                        totalDays += (contract.end - contract.start) / (1000 * 60 * 60 * 24);
                    }
                }
            }

            return totalDays;
        }

        function formatExperience(days) {
            const years = Math.floor(days / 365);
            const remainingAfterYears = days % 365;
            const months = Math.floor(remainingAfterYears / 30.44);
            const remainingDays = Math.floor(remainingAfterYears % 30.44);
            
            const parts = [];
            if (years > 0) parts.push(years + (years > 1 ? ' a√±os' : ' a√±o'));
            if (months > 0) parts.push(months + (months > 1 ? ' meses' : ' mes'));
            if (remainingDays > 0) parts.push(remainingDays + (remainingDays > 1 ? ' d√≠as' : ' d√≠a'));
            
            return parts.join(', ') || '0 d√≠as';
        }

        function deleteCandidate(index) {
            if (confirm('¬øEst√°s seguro de eliminar este candidato?')) {
                candidates.splice(index, 1);
                saveToStorage();
                renderCandidates();
            }
        }

        function exportToJSON() {
            const dataStr = JSON.stringify(candidates, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_candidatos_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('‚úÖ Backup descargado exitosamente');
        }

        function importFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.multiple = true;
            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;
                
                let allImported = [];
                let filesProcessed = 0;
                
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const imported = JSON.parse(event.target.result);
                            allImported = allImported.concat(imported);
                            filesProcessed++;
                            
                            if (filesProcessed === files.length) {
                                mergeAndImportData(allImported);
                            }
                        } catch (err) {
                            alert(`Error al leer ${file.name}`);
                            filesProcessed++;
                        }
                    };
                    reader.readAsText(file);
                });
            };
            input.click();
        }

        function mergeAndImportData(importedCandidates) {
            if (importedCandidates.length === 0) {
                alert('No se encontraron candidatos');
                return;
            }

            let duplicates = [];
            let newCandidates = [];
            
            importedCandidates.forEach(imported => {
                const isDuplicate = candidates.some(existing => 
                    existing.cedula === imported.cedula
                );
                
                if (isDuplicate) {
                    duplicates.push(imported);
                } else {
                    newCandidates.push(imported);
                }
            });

            let message = `üìä RESUMEN:\n\n`;
            message += `üìÅ Total: ${importedCandidates.length}\n`;
            message += `‚úÖ Nuevos: ${newCandidates.length}\n`;
            message += `‚ö†Ô∏è Duplicados: ${duplicates.length}\n\n`;
            
            if (newCandidates.length > 0) {
                message += `¬øImportar ${newCandidates.length} candidato(s)?`;
                
                if (confirm(message)) {
                    candidates = candidates.concat(newCandidates);
                    saveToStorage();
                    renderCandidates();
                    alert(`‚úÖ ${newCandidates.length} candidato(s) importado(s)`);
                }
            } else {
                alert('Todos los candidatos ya existen');
            }
        }

        function checkDuplicatesInFiles() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.multiple = true;
            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                if (files.length < 2) {
                    alert('Selecciona al menos 2 archivos');
                    return;
                }
                
                let allCandidates = [];
                let filesData = {};
                let filesProcessed = 0;
                
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        try {
                            const data = JSON.parse(event.target.result);
                            filesData[file.name] = data;
                            allCandidates = allCandidates.concat(data.map(c => ({...c, source: file.name})));
                            filesProcessed++;
                            
                            if (filesProcessed === files.length) {
                                analyzeDuplicates(allCandidates, filesData);
                            }
                        } catch (err) {
                            alert(`Error: ${file.name}`);
                            filesProcessed++;
                        }
                    };
                    reader.readAsText(file);
                });
            };
            input.click();
        }

        function analyzeDuplicates(allCandidates, filesData) {
            const seen = {};
            const duplicates = [];
            
            allCandidates.forEach(candidate => {
                const key = candidate.cedula;
                
                if (seen[key]) {
                    seen[key].push(candidate.source);
                    if (!duplicates.find(d => d.key === key)) {
                        duplicates.push({
                            key: key,
                            candidate: candidate,
                            sources: seen[key]
                        });
                    }
                } else {
                    seen[key] = [candidate.source];
                }
            });

            let report = 'üìä AN√ÅLISIS DE DUPLICADOS\n';
            report += '='.repeat(50) + '\n\n';
            report += `Archivos: ${Object.keys(filesData).length}\n`;
            report += `Total candidatos: ${allCandidates.length}\n`;
            report += `Duplicados: ${duplicates.length}\n\n`;
            
            if (duplicates.length > 0) {
                report += 'LISTA:\n' + '-'.repeat(50) + '\n\n';
                duplicates.forEach((dup, idx) => {
                    report += `${idx + 1}. ${dup.candidate.fullName}\n`;
                    report += `   CC: ${dup.candidate.cedula}\n`;
                    report += `   Aparece en:\n`;
                    dup.sources.forEach(source => {
                        report += `   - ${source}\n`;
                    });
                    report += '\n';
                });
            } else {
                report += '‚úÖ Sin duplicados\n';
            }

            alert(report);
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_duplicados_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è ¬øEliminar TODOS los datos? No se puede deshacer.')) {
                if (confirm('üî¥ √öLTIMA CONFIRMACI√ìN')) {
                    candidates = [];
                    localStorage.removeItem('candidatesData');
                    renderCandidates();
                    alert('‚úÖ Datos eliminados');
                }
            }
        }

        function renderCandidates() {
            const list = document.getElementById('candidatesList');
            const container = document.getElementById('candidatesContainer');
            const count = document.getElementById('candidatesCount');

            if (candidates.length === 0) {
                list.style.display = 'none';
                return;
            }

            list.style.display = 'block';
            count.textContent = candidates.length;

            let html = '';
            candidates.forEach((candidate, index) => {
                const contractsCount = candidate.contracts?.length || 0;
                const teachingCount = candidate.teachingExperience?.length || 0;
                const allExperiences = [
                    ...candidate.contracts.map(c => ({...c, type: 'laboral', name: c.company})),
                    ...(candidate.teachingExperience || []).map(t => ({...t, type: 'docente', name: t.institution}))
                ];
                const overlaps = getOverlaps(allExperiences);

                html += `
                    <div class="candidate-card">
                        <div class="candidate-header">
                            <div class="candidate-info">
                                <h3>${candidate.fullName}</h3>
                                <p>CC: ${candidate.cedula}</p>
                                <p>Guardado: ${candidate.savedAt}</p>
                                <p style="font-size: 12px; color: #666;">üíº ${contractsCount} laboral(es) | üéì ${teachingCount} docente(s)</p>
                                ${candidate.generalComments ? `<p style="font-size: 12px; color: #0066cc;">üí¨ ${candidate.generalComments}</p>` : ''}
                                <div style="margin-top: 10px;">
                                    <span class="validation-badge ${candidate.validated ? 'validated' : 'pending'}">
                                        ${candidate.validated ? '‚úÖ Validado' : '‚ö†Ô∏è Pendiente'}
                                    </span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-${candidate.validated ? 'success' : 'warning'} btn-small" onclick="toggleValidation(${index})">
                                    ${candidate.validated ? '‚úì' : '‚óã'}
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteCandidate(${index})">üóëÔ∏è</button>
                            </div>
                        </div>
                        
                        <div class="experience-badge">
                            <p>‚úÖ Experiencia Total: ${formatExperience(candidate.totalExperience)}</p>
                        </div>

                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="btn btn-success" style="flex: 1;" onclick="exportToExcel(${index})">üì• Descargar Excel</button>
                        </div>

                        ${overlaps.length > 0 ? `
                        <div class="warning-box">
                            <p><strong>‚ö†Ô∏è Traslapes Detectados: ${overlaps.length}</strong></p>
                            ${overlaps.slice(0, 3).map(overlap => {
                                const type1 = overlap.contract1.type === 'laboral' ? 'üíº' : 'üéì';
                                const type2 = overlap.contract2.type === 'laboral' ? 'üíº' : 'üéì';
                                return `<p>‚Ä¢ ${type1} ${overlap.contract1.name} y ${type2} ${overlap.contract2.name}: ${Math.floor(overlap.days)} d√≠as</p>`;
                            }).join('')}
                            ${overlaps.length > 3 ? `<p>... y ${overlaps.length - 3} m√°s</p>` : ''}
                        </div>
                        ` : ''}

                        ${contractsCount > 0 ? `
                        <details>
                            <summary>Ver ${contractsCount} contrato(s) laboral(es)</summary>
                            <div style="overflow-x: auto;">
                                <table class="contract-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Ciudad</th>
                                            <th>Empresa</th>
                                            <th>Cargo</th>
                                            <th>Inicio</th>
                                            <th>Fin</th>
                                            <th>Duraci√≥n</th>
                                            <th>Comentarios</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${candidate.contracts.map((c, cIdx) => {
                                            const days = Math.floor((new Date(c.endDate) - new Date(c.startDate)) / (1000 * 60 * 60 * 24));
                                            const isError = days <= 0;
                                            return `
                                            <tr class="${isError ? 'error-row' : ''}">
                                                <td>${cIdx + 1}</td>
                                                <td><input type="text" value="${c.city || ''}" onchange="updateContract(${index}, ${c.id}, 'city', this.value)"></td>
                                                <td><input type="text" value="${c.company}" onchange="updateContract(${index}, ${c.id}, 'company', this.value)"></td>
                                                <td><input type="text" value="${c.position}" onchange="updateContract(${index}, ${c.id}, 'position', this.value)"></td>
                                                <td><input type="date" value="${c.startDate}" onchange="updateContract(${index}, ${c.id}, 'startDate', this.value); renderCandidates()"></td>
                                                <td><input type="date" value="${c.endDate}" onchange="updateContract(${index}, ${c.id}, 'endDate', this.value); renderCandidates()"></td>
                                                <td>${isError ? '‚ùå' : formatExperience(days)}</td>
                                                <td><textarea onchange="updateContract(${index}, ${c.id}, 'comments', this.value)">${c.comments || ''}</textarea></td>
                                                <td>
                                                    <div class="action-buttons">
                                                        <button class="btn btn-warning btn-small" onclick="duplicateContract(${index}, ${c.id})">üìã</button>
                                                        <button class="btn btn-danger btn-small" onclick="deleteContract(${index}, ${c.id})">üóëÔ∏è</button>
                                                    </div>
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                        ` : ''}

                        ${teachingCount > 0 ? `
                        <details style="margin-top: 10px;">
                            <summary>Ver ${teachingCount} experiencia(s) docente(s)</summary>
                            <div style="overflow-x: auto;">
                                <table class="contract-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Ciudad</th>
                                            <th>Instituci√≥n</th>
                                            <th>Modalidad</th>
                                            <th>Programa</th>
                                            <th>Dedicaci√≥n</th>
                                            <th>H/Sem</th>
                                            <th>Inicio</th>
                                            <th>Fin</th>
                                            <th>Equiv.</th>
                                            <th>Comentarios</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${candidate.teachingExperience.map((t, tIdx) => {
                                            const equivDays = calculateTeachingEquivalent(t);
                                            const isError = equivDays <= 0;
                                            return `
                                            <tr class="${isError ? 'error-row' : ''}">
                                                <td>${tIdx + 1}</td>
                                                <td><input type="text" value="${t.city || ''}" onchange="updateTeaching(${index}, ${t.id}, 'city', this.value)"></td>
                                                <td><input type="text" value="${t.institution}" onchange="updateTeaching(${index}, ${t.id}, 'institution', this.value)"></td>
                                                <td><input type="text" value="${t.modality}" onchange="updateTeaching(${index}, ${t.id}, 'modality', this.value)"></td>
                                                <td><input type="text" value="${t.program}" onchange="updateTeaching(${index}, ${t.id}, 'program', this.value)"></td>
                                                <td>
                                                    <select onchange="updateTeaching(${index}, ${t.id}, 'dedication', this.value); renderCandidates()">
                                                        <option value="Tiempo completo" ${t.dedication === 'Tiempo completo' ? 'selected' : ''}>Tiempo completo</option>
                                                        <option value="Medio tiempo" ${t.dedication === 'Medio tiempo' ? 'selected' : ''}>Medio tiempo</option>
                                                        <option value="Hora Catedra" ${t.dedication === 'Hora Catedra' ? 'selected' : ''}>Hora C√°tedra</option>
                                                    </select>
                                                </td>
                                                <td>${t.dedication === 'Hora Catedra' ? `<input type="number" value="${t.hoursPerWeek || ''}" onchange="updateTeaching(${index}, ${t.id}, 'hoursPerWeek', parseInt(this.value)); renderCandidates()" min="1" style="width: 60px;">` : '-'}</td>
                                                <td><input type="date" value="${t.startDate}" onchange="updateTeaching(${index}, ${t.id}, 'startDate', this.value); renderCandidates()"></td>
                                                <td><input type="date" value="${t.endDate}" onchange="updateTeaching(${index}, ${t.id}, 'endDate', this.value); renderCandidates()"></td>
                                                <td>${isError ? '‚ùå' : formatExperience(equivDays)}</td>
                                                <td><textarea onchange="updateTeaching(${index}, ${t.id}, 'comments', this.value)">${t.comments || ''}</textarea></td>
                                                <td>
                                                    <div class="action-buttons">
                                                        <button class="btn btn-warning btn-small" onclick="duplicateTeaching(${index}, ${t.id})">üìã</button>
                                                        <button class="btn btn-danger btn-small" onclick="deleteTeaching(${index}, ${t.id})">üóëÔ∏è</button>
                                                    </div>
                                                </td>
                                            </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function exportToExcel(index) {
            const candidate = candidates[index];
            const overlaps = getOverlaps([
                ...candidate.contracts.map(c => ({...c, type: 'laboral', name: c.company})),
                ...(candidate.teachingExperience || []).map(t => ({...t, type: 'docente', name: t.institution}))
            ]);

            const resumenData = [
                ['REPORTE DE EXPERIENCIA LABORAL Y DOCENTE'],
                [],
                ['Nombre:', candidate.fullName],
                ['C√©dula:', candidate.cedula],
                ['Fecha:', candidate.savedAt],
                ['Validado:', candidate.validated ? 'S√ç' : 'NO'],
                [],
                ['EXPERIENCIA TOTAL:', formatExperience(candidate.totalExperience)],
                [],
                ['Contratos:', candidate.contracts?.length || 0],
                ['Docente:', candidate.teachingExperience?.length || 0],
                ['Traslapes:', overlaps.length]
            ];

            const contractsData = [
                ['EXPERIENCIA LABORAL'],
                [],
                ['No.', 'Ciudad', 'Empresa', 'Cargo', 'Inicio', 'Fin', 'Duraci√≥n', 'Comentarios']
            ];
            
            if (candidate.contracts && candidate.contracts.length > 0) {
                candidate.contracts.forEach((contract, idx) => {
                    const days = Math.floor((new Date(contract.endDate) - new Date(contract.startDate)) / (1000 * 60 * 60 * 24));
                    contractsData.push([
                        idx + 1,
                        contract.city || '',
                        contract.company,
                        contract.position,
                        new Date(contract.startDate).toLocaleDateString(),
                        new Date(contract.endDate).toLocaleDateString(),
                        formatExperience(days),
                        contract.comments || ''
                    ]);
                });
            }

            const teachingData = [
                ['EXPERIENCIA DOCENTE'],
                [],
                ['No.', 'Ciudad', 'Instituci√≥n', 'Modalidad', 'Programa', 'Dedicaci√≥n', 'H/Sem', 'Inicio', 'Fin', 'Equiv.', 'Comentarios']
            ];

            if (candidate.teachingExperience && candidate.teachingExperience.length > 0) {
                candidate.teachingExperience.forEach((teach, idx) => {
                    const equivDays = calculateTeachingEquivalent(teach);
                    teachingData.push([
                        idx + 1,
                        teach.city || '',
                        teach.institution,
                        teach.modality,
                        teach.program,
                        teach.dedication,
                        teach.hoursPerWeek || '-',
                        new Date(teach.startDate).toLocaleDateString(),
                        new Date(teach.endDate).toLocaleDateString(),
                        formatExperience(equivDays),
                        teach.comments || ''
                    ]);
                });
            }

            const overlapsData = [
                ['TRASLAPES'],
                [],
                ['No.', 'Tipo 1', 'Exp 1', 'Tipo 2', 'Exp 2', 'D√≠as']
            ];
            
            if (overlaps.length > 0) {
                overlaps.forEach((overlap, idx) => {
                    overlapsData.push([
                        idx + 1,
                        overlap.contract1.type === 'laboral' ? 'Laboral' : 'Docente',
                        overlap.contract1.name,
                        overlap.contract2.type === 'laboral' ? 'Laboral' : 'Docente',
                        overlap.contract2.name,
                        Math.floor(overlap.days)
                    ]);
                });
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(resumenData), 'Resumen');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(contractsData), 'Laboral');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(teachingData), 'Docente');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(overlapsData), 'Traslapes');
            
            XLSX.writeFile(wb, `experiencia_${candidate.cedula}.xlsx`);
        }

        function exportAllCandidates() {
            if (candidates.length === 0) {
                alert('No hay candidatos');
                return;
            }

            const resumenData = [
                ['REPORTE CONSOLIDADO'],
                ['Fecha:', new Date().toLocaleString()],
                ['Total:', candidates.length],
                [],
                ['No.', 'Nombre', 'C√©dula', 'Exp Total', 'Laboral', 'Docente', 'Validado', 'Fecha']
            ];

            candidates.forEach((candidate, idx) => {
                resumenData.push([
                    idx + 1,
                    candidate.fullName,
                    candidate.cedula,
                    formatExperience(candidate.totalExperience),
                    (candidate.contracts?.length || 0) + ' contrato(s)',
                    (candidate.teachingExperience?.length || 0) + ' exp(s)',
                    candidate.validated ? 'S√ç' : 'NO',
                    candidate.savedAt
                ]);
            });

            const allContractsData = [
                ['EXPERIENCIA LABORAL - TODOS'],
                [],
                ['Nombre', 'C√©dula', 'Ciudad', 'Empresa', 'Cargo', 'Inicio', 'Fin', 'Duraci√≥n', 'Validado']
            ];

            candidates.forEach(candidate => {
                if (candidate.contracts && candidate.contracts.length > 0) {
                    candidate.contracts.forEach(contract => {
                        const days = Math.floor((new Date(contract.endDate) - new Date(contract.startDate)) / (1000 * 60 * 60 * 24));
                        allContractsData.push([
                            candidate.fullName,
                            candidate.cedula,
                            contract.city || '',
                            contract.company,
                            contract.position,
                            new Date(contract.startDate).toLocaleDateString(),
                            new Date(contract.endDate).toLocaleDateString(),
                            formatExperience(days),
                            candidate.validated ? 'S√ç' : 'NO'
                        ]);
                    });
                }
            });

            const allTeachingData = [
                ['EXPERIENCIA DOCENTE - TODOS'],
                [],
                ['Nombre', 'C√©dula', 'Ciudad', 'Instituci√≥n', 'Modalidad', 'Programa', 'Dedicaci√≥n', 'H/Sem', 'Inicio', 'Fin', 'Equiv.', 'Validado']
            ];

            candidates.forEach(candidate => {
                if (candidate.teachingExperience && candidate.teachingExperience.length > 0) {
                    candidate.teachingExperience.forEach(teach => {
                        const equivDays = calculateTeachingEquivalent(teach);
                        allTeachingData.push([
                            candidate.fullName,
                            candidate.cedula,
                            teach.city || '',
                            teach.institution,
                            teach.modality,
                            teach.program,
                            teach.dedication,
                            teach.hoursPerWeek || '-',
                            new Date(teach.startDate).toLocaleDateString(),
                            new Date(teach.endDate).toLocaleDateString(),
                            formatExperience(equivDays),
                            candidate.validated ? 'S√ç' : 'NO'
                        ]);
                    });
                }
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(resumenData), 'Resumen');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(allContractsData), 'Todos - Laboral');
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(allTeachingData), 'Todos - Docente');
            
            XLSX.writeFile(wb, `reporte_completo_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
    </script>
</body>
</html>
